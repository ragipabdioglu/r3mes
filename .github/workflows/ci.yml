name: CI

# Sadece manuel tetikleme - otomatik çalışmaz
on:
  workflow_dispatch:
    inputs:
      run_all:
        description: 'Run all tests'
        required: false
        default: 'true'

# Otomatik tetikleyiciler devre dışı
# on:
#   push:
#     branches: [main, develop]
#   pull_request:
#     branches: [main, develop]

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Run unit tests
        working-directory: backend
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=term || true
        env:
          R3MES_ENV: test
          DATABASE_TYPE: sqlite

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
          cache-dependency-path: web-dashboard/package-lock.json
      
      - name: Install dependencies
        working-directory: web-dashboard
        run: npm ci --legacy-peer-deps
      
      - name: Run unit tests
        working-directory: web-dashboard
        run: npm test -- --coverage --passWithNoTests || true
        env:
          CI: true

  blockchain-tests:
    name: Blockchain Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: remes/go.sum
      
      - name: Run Go tests
        working-directory: remes
        run: |
          go test ./... -v || true
