# R3MES Production ConfigMaps
# Non-sensitive configuration data

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: r3mes-config
  namespace: r3mes
  labels:
    app: r3mes
data:
  # Backend Configuration
  blockchain-rpc-url: "https://rpc.mainnet.r3mes.network:26657"
  blockchain-rest-url: "https://api.mainnet.r3mes.network:1317"
  cors-allowed-origins: "https://r3mes.network,https://app.r3mes.network"
  rate-limit-chat: "10/minute"
  rate-limit-api: "100/minute"
  log-level: "INFO"
  enable-file-logging: "true"
  
  # Performance Configuration
  backend-metrics-interval: "10.0"
  backend-shutdown-timeout: "30.0"
  cache-ttl: "300"
  max-connections: "100"
  worker-processes: "4"
  
  # Feature Flags
  enable-debug-endpoints: "false"
  enable-websockets: "true"
  enable-metrics: "true"
  enable-tracing: "true"
  
  # Monitoring Configuration
  prometheus-enabled: "true"
  jaeger-endpoint: "http://jaeger-collector:14268/api/traces"
  sentry-environment: "production"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: r3mes-frontend-config
  namespace: r3mes
  labels:
    app: r3mes
    component: frontend
data:
  api-url: "https://api.r3mes.network"
  backend-url: "https://api.r3mes.network"
  site-url: "https://r3mes.network"
  environment: "production"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: r3mes
  labels:
    app: r3mes
    component: database
data:
  postgresql.conf: |
    # PostgreSQL Configuration for R3MES Production
    # Optimized for connection pooling and performance

    # Connection Settings
    max_connections = 200
    shared_buffers = 256MB
    effective_cache_size = 1GB
    work_mem = 4MB
    maintenance_work_mem = 64MB

    # Connection Pooling Optimization
    tcp_keepalives_idle = 600
    tcp_keepalives_interval = 30
    tcp_keepalives_count = 3

    # Performance Tuning
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200

    # Logging
    log_destination = 'stderr'
    logging_collector = on
    log_directory = 'pg_log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_min_duration_statement = 1000
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_lock_waits = on

    # Security
    ssl = off
    password_encryption = scram-sha-256

    # Autovacuum
    autovacuum = on
    autovacuum_max_workers = 3
    autovacuum_naptime = 1min
    autovacuum_vacuum_threshold = 50
    autovacuum_analyze_threshold = 50
    autovacuum_vacuum_scale_factor = 0.2
    autovacuum_analyze_scale_factor = 0.1

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: r3mes
  labels:
    app: r3mes
    component: database
data:
  init.sql: |
    -- PostgreSQL Initialization Script for R3MES
    -- Creates optimized database schema with proper indexing

    -- Enable required extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

    -- Performance monitoring view
    CREATE OR REPLACE VIEW connection_stats AS
    SELECT 
        state,
        count(*) as connections,
        max(now() - state_change) as max_duration
    FROM pg_stat_activity 
    WHERE pid != pg_backend_pid()
    GROUP BY state;

    -- Grant permissions for monitoring
    GRANT SELECT ON connection_stats TO PUBLIC;

    -- Log successful initialization
    DO $$
    BEGIN
        RAISE NOTICE 'R3MES PostgreSQL database initialized successfully';
    END $$;