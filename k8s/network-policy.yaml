# R3MES Kubernetes Network Policies
# Production-ready network segmentation and security

# Default deny all ingress traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: r3mes
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Default deny all egress traffic (except DNS)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: r3mes
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Backend Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: r3mes-backend-policy
  namespace: r3mes
spec:
  podSelector:
    matchLabels:
      app: r3mes-backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from nginx/ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8000
  # Allow ingress from monitoring
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
  egress:
  # Allow egress to database
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # Allow egress to Redis
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  # Allow egress to blockchain node
  - to:
    - podSelector:
        matchLabels:
          app: r3mes-blockchain
    ports:
    - protocol: TCP
      port: 26657
    - protocol: TCP
      port: 1317
  # Allow HTTPS egress for external APIs
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Blockchain Node Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: r3mes-blockchain-policy
  namespace: r3mes
spec:
  podSelector:
    matchLabels:
      app: r3mes-blockchain
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from backend
  - from:
    - podSelector:
        matchLabels:
          app: r3mes-backend
    ports:
    - protocol: TCP
      port: 26657
    - protocol: TCP
      port: 1317
  # Allow ingress from other blockchain nodes (P2P)
  - from: []
    ports:
    - protocol: TCP
      port: 26656
  # Allow monitoring
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 26660
  egress:
  # Allow P2P communication with other nodes
  - to: []
    ports:
    - protocol: TCP
      port: 26656
  # Allow HTTPS for external blockchain communication
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Miner Engine Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: r3mes-miner-policy
  namespace: r3mes
spec:
  podSelector:
    matchLabels:
      app: r3mes-miner
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from backend for stats
  - from:
    - podSelector:
        matchLabels:
          app: r3mes-backend
    ports:
    - protocol: TCP
      port: 8080
  # Allow monitoring
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9091
  egress:
  # Allow egress to backend for submissions
  - to:
    - podSelector:
        matchLabels:
          app: r3mes-backend
    ports:
    - protocol: TCP
      port: 8000
  # Allow IPFS communication
  - to:
    - podSelector:
        matchLabels:
          app: ipfs
    ports:
    - protocol: TCP
      port: 5001
  # Allow HTTPS for model downloads
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Database Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-policy
  namespace: r3mes
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Only allow ingress from backend
  - from:
    - podSelector:
        matchLabels:
          app: r3mes-backend
    ports:
    - protocol: TCP
      port: 5432
  # Allow monitoring
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9187
  egress:
  # Allow DNS only
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Redis Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-policy
  namespace: r3mes
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Only allow ingress from backend
  - from:
    - podSelector:
        matchLabels:
          app: r3mes-backend
    ports:
    - protocol: TCP
      port: 6379
  # Allow monitoring
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9121
  egress:
  # Allow DNS only
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Monitoring Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-policy
  namespace: r3mes
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from Grafana
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 9090
  # Allow ingress from nginx for external access
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 9090
  egress:
  # Allow scraping all R3MES services
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: r3mes
    ports:
    - protocol: TCP
      port: 8000
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 9091
    - protocol: TCP
      port: 26660
  # Allow Kubernetes API access for service discovery
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Web Dashboard Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-dashboard-policy
  namespace: r3mes
spec:
  podSelector:
    matchLabels:
      app: r3mes-web
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from nginx/ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 3000
  egress:
  # Allow egress to backend API
  - to:
    - podSelector:
        matchLabels:
          app: r3mes-backend
    ports:
    - protocol: TCP
      port: 8000
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53