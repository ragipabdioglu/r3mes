version: '3.8'

# R3MES Miner Engine - Docker Compose Configuration
# For containerized mining with NVIDIA GPU support
#
# Usage:
#   docker compose -f docker-compose.miner.yml up -d
#
# Prerequisites:
#   - NVIDIA GPU with CUDA support
#   - NVIDIA Container Toolkit installed
#   - Docker 19.03+ with GPU support

services:
  miner:
    build:
      context: .
      dockerfile: Dockerfile.miner
    container_name: r3mes-miner
    runtime: nvidia
    environment:
      # GPU Configuration
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      
      # Blockchain Connection
      - BLOCKCHAIN_RPC_URL=${BLOCKCHAIN_RPC_URL:-http://host.docker.internal:26657}
      - BLOCKCHAIN_GRPC_URL=${BLOCKCHAIN_GRPC_URL:-host.docker.internal:9090}
      - CHAIN_ID=${CHAIN_ID:-remes-mainnet-1}
      
      # Miner Configuration
      - MINER_WALLET_ADDRESS=${MINER_WALLET_ADDRESS}
      - MINER_WALLET_NAME=${MINER_WALLET_NAME:-miner}
      - MINER_KEYRING_BACKEND=${MINER_KEYRING_BACKEND:-file}
      
      # Model Configuration
      - BASE_MODEL_PATH=/app/checkpoints/base_model
      - LORA_ADAPTERS_PATH=/app/checkpoints/adapters
      
      # Training Configuration
      - BATCH_SIZE=${BATCH_SIZE:-4}
      - LEARNING_RATE=${LEARNING_RATE:-2e-5}
      - MAX_EPOCHS=${MAX_EPOCHS:-3}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/miner.log
      
      # Backend API (for stats reporting)
      - BACKEND_API_URL=${BACKEND_API_URL:-https://api.r3mes.network}
    volumes:
      # Model checkpoints (persistent)
      - miner_checkpoints:/app/checkpoints
      # Training data
      - miner_data:/app/data
      # Logs
      - miner_logs:/app/logs
      # Keyring (for wallet access)
      - ${REMESD_HOME:-~/.remes}:/root/.remes:ro
    ports:
      # Stats HTTP server
      - "${MINER_STATS_PORT:-8081}:8081"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-1}
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import torch; assert torch.cuda.is_available()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # Optional: Local stats dashboard
  stats-dashboard:
    image: grafana/grafana:latest
    container_name: r3mes-miner-stats
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    depends_on:
      - miner
    profiles:
      - monitoring
    restart: unless-stopped

volumes:
  miner_checkpoints:
    driver: local
  miner_data:
    driver: local
  miner_logs:
    driver: local
  grafana_data:
    driver: local

networks:
  default:
    name: r3mes-miner-network
