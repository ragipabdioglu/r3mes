#!/usr/bin/env python3
"""
Initialize Blockchain with Custom Genesis JSON

This script initializes a new blockchain node using a custom genesis.json file
generated by finalize_genesis.py. It handles the initialization process properly
by ensuring all necessary files are created.

Usage:
    python scripts/init_genesis_with_custom.py --genesis remes/config/genesis.json --chain-id remes-mainnet-1
"""

import argparse
import json
import os
import shutil
import subprocess
import sys
from pathlib import Path


def main():
    parser = argparse.ArgumentParser(
        description="Initialize blockchain with custom genesis.json"
    )
    parser.add_argument(
        "--genesis",
        type=str,
        required=True,
        help="Path to custom genesis.json file"
    )
    parser.add_argument(
        "--chain-id",
        type=str,
        required=True,
        help="Chain ID (must match genesis.json)"
    )
    parser.add_argument(
        "--moniker",
        type=str,
        default="r3mes-node",
        help="Node moniker (default: r3mes-node)"
    )
    parser.add_argument(
        "--home",
        type=str,
        default=None,
        help="Node home directory (default: ~/.remesd)"
    )
    parser.add_argument(
        "--remesd-path",
        type=str,
        default="remesd",
        help="Path to remesd binary (default: remesd in PATH)"
    )
    parser.add_argument(
        "--force",
        action="store_true",
        help="Force re-initialization (will delete existing node data)"
    )
    
    args = parser.parse_args()
    
    # Convert paths
    project_root = Path(__file__).parent.parent
    genesis_path = project_root / args.genesis if not os.path.isabs(args.genesis) else Path(args.genesis)
    home_dir = Path(args.home) if args.home else Path.home() / ".remesd"
    
    print("=" * 60)
    print("R3MES Blockchain Initialization with Custom Genesis")
    print("=" * 60)
    print(f"Genesis file: {genesis_path}")
    print(f"Chain ID: {args.chain_id}")
    print(f"Moniker: {args.moniker}")
    print(f"Home directory: {home_dir}")
    print("=" * 60)
    print()
    
    # Check genesis file exists
    if not genesis_path.exists():
        print(f"❌ Error: Genesis file not found: {genesis_path}")
        sys.exit(1)
    
    # Validate genesis.json
    try:
        with open(genesis_path, 'r') as f:
            genesis = json.load(f)
        
        # Check chain ID matches
        if genesis.get("chain_id") != args.chain_id:
            print(f"⚠️  Warning: Genesis chain_id ({genesis.get('chain_id')}) doesn't match provided chain_id ({args.chain_id})")
            response = input("Continue anyway? (y/n): ")
            if response.lower() != 'y':
                sys.exit(1)
    except json.JSONDecodeError as e:
        print(f"❌ Error: Invalid JSON in genesis file: {e}")
        sys.exit(1)
    
    # Check if node already initialized
    config_dir = home_dir / "config"
    if config_dir.exists() and (config_dir / "config.toml").exists():
        if args.force:
            print(f"⚠️  Force flag set. Removing existing node data at {home_dir}")
            shutil.rmtree(home_dir)
        else:
            print(f"⚠️  Node already initialized at {home_dir}")
            print("   Use --force to re-initialize (will delete existing data)")
            print("   Or manually copy genesis.json to:")
            print(f"   {config_dir / 'genesis.json'}")
            sys.exit(1)
    
    # Step 1: Initialize node (creates directory structure and config files)
    print("Step 1: Initializing node directory structure...")
    try:
        cmd = [
            args.remesd_path,
            "init",
            args.moniker,
            "--chain-id", args.chain_id,
            "--home", str(home_dir)
        ]
        
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            check=True
        )
        print("✅ Node directory structure created")
    except subprocess.CalledProcessError as e:
        print(f"❌ Error initializing node: {e.stderr}")
        sys.exit(1)
    except FileNotFoundError:
        print(f"❌ Error: remesd binary not found at '{args.remesd_path}'")
        print("   Set --remesd-path or ensure remesd is in PATH")
        sys.exit(1)
    
    # Step 2: Replace default genesis.json with custom one
    print(f"Step 2: Copying custom genesis.json to {config_dir / 'genesis.json'}...")
    try:
        shutil.copy(genesis_path, config_dir / "genesis.json")
        print("✅ Custom genesis.json copied")
    except Exception as e:
        print(f"❌ Error copying genesis file: {e}")
        sys.exit(1)
    
    # Step 3: Validate genesis
    print("Step 3: Validating genesis.json...")
    try:
        cmd = [
            args.remesd_path,
            "genesis",
            "validate-genesis",
            "--home", str(home_dir)
        ]
        
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            check=True
        )
        print("✅ Genesis validation passed")
    except subprocess.CalledProcessError as e:
        print(f"❌ Error validating genesis: {e.stderr}")
        print("   Please check your genesis.json file")
        sys.exit(1)
    
    # Summary
    print()
    print("=" * 60)
    print("✅ Blockchain initialization completed successfully!")
    print("=" * 60)
    print(f"Node home: {home_dir}")
    print(f"Chain ID: {args.chain_id}")
    print(f"Moniker: {args.moniker}")
    print()
    print("Next steps:")
    print(f"1. Create or import keys: {args.remesd_path} keys add <key-name> --home {home_dir}")
    print(f"2. Start node: {args.remesd_path} start --home {home_dir}")
    print("=" * 60)


if __name__ == "__main__":
    main()

